name: Tests

on: [push]

env:
  SONAR_SCANNER_VERSION: 4.2.0.1873

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: '13.x'
      - name: Install
        run: npm install
      - name: Pretest
        run: npm run pretest
      - name: Test
        run: npm test
      - name: Download and install sonar-scanner
        run: |
          mkdir -p $HOME/.sonar \
          && wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip -O sonar-scanner.zip \
          && unzip sonar-scanner.zip -d $HOME/.sonar/ \
          && rm sonar-scanner.zip
      - name: SonarCloud
        run: |
          $HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux/bin/sonar-scanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}
          SONAR_SCANNER_OPTS: "-server"
